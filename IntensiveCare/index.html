<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="../GameMgr/CWGame.js"></script> 
    <script type="text/javascript" src="../GameMgr/MockGame.js"></script> 
    <script type="text/javascript" src="../GameMgr/lib/jquery-1.10.0.min.js"></script>
    <script type="text/javascript" src="loader.js"></script>
    <style type="text/css">
    h1 {
        margin: 9% auto;
        text-align: center;
    }
    #timeremain {
        position: absolute;
        top: 0;
        width: 100%;
        height: 20px;
    }
    </style>
</head>
<body>
    <div id="ecg">
        <img id="heart" />
        <span id="heartbeat">0</span>
    </div>
    <progress id="timeremain" value="10" max="10"></progress>
    <h1 id="welcome">Sauve le chat, mais ne le grille pas !</h1>
    <canvas id="canvas" width="800" height="480"></canvas>

    <script type="text/javascript">
    function gameLoad(gameMgr) {
        var loader = new Loader(function(){
            gameMgr.ready();
        });

        // dead cat
        var woundedCatImage = new Image();
        loader.attachedOne();
        woundedCatImage.onload = function(){
            loader.finishedOne();
        };
        woundedCatImage.src = 'chat-vivant.png';

        // dead cat
        var deadCatImage = new Image();
        loader.attachedOne();
        deadCatImage.onload = function(){
            loader.finishedOne();
        };
        deadCatImage.src = 'chat-mort.png';

        // dead cat
        var grilledCatImage = new Image();
        loader.attachedOne();
        grilledCatImage.onload = function(){
            loader.finishedOne();
        };
        grilledCatImage.src = 'cat.jpg';

        // battery
        var batteryImage = new Image();
        loader.attachedOne();
        batteryImage.onload = function(){
            loader.finishedOne();
        };
        batteryImage.src = 'battery.jpeg';


        loader.gogogo();

        // configure your game
        gameMgr.onStart(function(params) {
            
            function IntensiveCare() {
                var canvas = document.getElementById('canvas');
                var context = canvas.getContext('2d');

                var endPoint = { x:300, y:200 };
                var ctx = {
                    time: 10,
                    cat: {
                        x: 200,
                        y: 250,
                        width: 150,
                        height: 100
                    },
                    battery: {
                        x: 0,
                        y: 250,
                        width: 100,
                        height: 100
                    },
                    playing: true,
                    counter_min: 30,
                    counter_max: 70,
                    counter: 0,
                    score: 0,
                    statuses : ['dead', 'reanimating', 'grilled', 'alive'],
                    status: 'dead',
                };

                function updateStatus() {
                    if (ctx.counter < ctx.counter_min) {
                        ctx.status = 'dead';
                    } else if (ctx.counter < ctx.counter_max) {
                        ctx.status = 'reanimating';
                    } else {
                        ctx.status = 'grilled';
                    }
                    console.log(ctx.status);
                }

                function bzzt() {
                    ctx.counter++;
                    updateStatus();
                }

                function timeDecay() {
                    if (ctx.playing) {
                        ctx.counter -= 1;
                        $('#timeremain').val(--ctx.time);

                        if (ctx.counter < 0) {
                            ctx.counter = 0;
                        }
                        updateStatus();
                        //console.log('decr' + ctx.counter);
                    }
                }    

                function untilTimeout() {
                    ctx.playing = false;
                    updateStatus();
                    if (ctx.status == 'reanimating') {
                        ctx.status = 'alive';
                    }
                    if (ctx.status == 'dead' || ctx.status == 'grilled') {                        
                        $('#welcome').show().html('Le chat est mort !');
                        $('#canvas').hide();
                        setTimeout(function(){
                            gameMgr.end(false, 0);
                        }, 1000);
    
                    } else {
                        $('#welcome').show().html('Le chat est vivant !');
                        $('#canvas').hide();
                        setTimeout(function(){
                            gameMgr.end(true, Math.abs(50 - ctx.counter));
                        }, 1000);
                    }
                }

                function onDocumentMouseMove(event) {
                    endPoint.x = event.clientX;
                    endPoint.y = event.clientY;

                    if ((endPoint.x > ctx.cat.x && endPoint.x < ctx.cat.x + ctx.cat.width)
                     && (endPoint.y > ctx.cat.y && endPoint.y < ctx.cat.y + ctx.cat.height)) {
                       bzzt();
                    }
                }

                var cats = {
                    dead: woundedCatImage,
                    alive: woundedCatImage,
                    grilled: grilledCatImage,
                    reanimating: deadCatImage,
                };

                function render() {
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    context.drawImage(batteryImage, ctx.battery.x, ctx.battery.y, ctx.battery.width, ctx.battery.height);
                    context.drawImage(cats[ ctx.status ], ctx.cat.x, ctx.cat.y, ctx.cat.width, ctx.cat.height);

                    context.beginPath();
                    context.lineWidth = 5;
                    context.moveTo(20, 276);
                    context.bezierCurveTo(140, 200, 388, 10, endPoint.x - 1, endPoint.y + 10);
                    context.strokeStyle = 'orange';
                    context.stroke();

                    context.beginPath();
                    context.lineWidth = 10;
                    context.moveTo(20, 276);
                    context.bezierCurveTo(140, 200, 388, 10, endPoint.x, endPoint.y);
                    context.strokeStyle = 'black';
                    context.stroke();

                    context.beginPath();
                    context.lineWidth = 5;
                    context.moveTo(72, 276);
                    context.bezierCurveTo(140, 200, 388, 10, endPoint.x + 50 - 1, endPoint.y + 10);
                    context.strokeStyle = 'orange';
                    context.stroke();

                    context.beginPath();
                    context.lineWidth = 10;
                    context.moveTo(72, 276);
                    context.bezierCurveTo(140, 200, 388, 10, endPoint.x + 50, endPoint.y);
                    context.strokeStyle = 'red';
                    context.stroke();

                    requestAnimationFrame(render);
                }

                render();
                setInterval(timeDecay, 1000);
                setTimeout(untilTimeout, 11000);
                document.addEventListener('mousemove', onDocumentMouseMove, false);                
            }

            setTimeout(function() {
                $('#welcome').hide();

                IntensiveCare();
            }, 1000);
        });
    }; 
    </script>  
</body>
</html>